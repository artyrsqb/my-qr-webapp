<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>QR Pro Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            --card-bg: var(--tg-theme-bg-color, #ffffff);
            --text-color: var(--tg-theme-text-color, #000000);
            --accent-color: var(--tg-theme-button-color, #3390ec);
            --button-text: var(--tg-theme-button-text-color, #ffffff);
            --hint-color: var(--tg-theme-hint-color, #999999);
        }

        body {
            font-family: -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 15px;
            display: flex; flex-direction: column; align-items: center;
        }

        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            width: 100%; max-width: 360px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            box-sizing: border-box;
        }

        h3 { text-align: center; margin-top: 0; margin-bottom: 20px; }

        /* –í–∫–ª–∞–¥–∫–∏ */
        .tabs { 
            display: flex; gap: 5px; margin-bottom: 15px; 
            background: var(--bg-color); padding: 4px; border-radius: 12px; 
        }
        .tab { 
            flex: 1; padding: 10px; border: none; border-radius: 10px; 
            cursor: pointer; background: none; color: var(--text-color); 
            font-size: 14px; font-weight: 500; transition: 0.2s;
        }
        .tab.active { 
            background: var(--card-bg); 
            box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
            color: var(--accent-color);
        }

        /* –ü–æ–ª—è –≤–≤–æ–¥–∞ */
        input {
            width: 100%; padding: 14px; margin-bottom: 12px;
            border: 1px solid #ddd; border-radius: 12px;
            box-sizing: border-box; font-size: 16px; outline: none;
            background: var(--card-bg); color: var(--text-color);
        }

        #wifi_fields { display: none; flex-direction: column; }

        /* –¶–≤–µ—Ç */
        .color-row { 
            display: flex; justify-content: space-between; align-items: center; 
            margin: 10px 0 20px 0; padding: 0 5px;
        }
        input[type="color"] { 
            width: 44px; height: 44px; padding: 0; border: none; 
            background: none; cursor: pointer; border-radius: 50%; 
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        .main-btn {
            width: 100%; padding: 16px; background: var(--accent-color);
            color: var(--button-text); border: none; border-radius: 14px;
            font-size: 16px; font-weight: bold; cursor: pointer;
        }

        .save-btn {
            width: 100%; padding: 14px; background: #28a745;
            color: white; border: none; border-radius: 12px;
            font-size: 14px; font-weight: bold; cursor: pointer; margin-top: 15px;
        }

        /* –†–µ–∑—É–ª—å—Ç–∞—Ç */
        #qrcode-container {
            margin-top: 25px; text-align: center; display: none;
        }
        #qrcode canvas {
            margin: 0 auto; border: 8px solid #fff; border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 100%;
        }
        
        .hint-text {
            font-size: 12px;
            color: var(--hint-color);
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <div class="card">
        <h3>QR Pro Generator</h3>

        <div class="tabs">
            <button id="tab-text" class="tab active" onclick="switchTab('text')">–¢–µ–∫—Å—Ç</button>
            <button id="tab-wifi" class="tab" onclick="switchTab('wifi')">Wi-Fi</button>
        </div>

        <input type="text" id="qr_input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ —Å—Å—ã–ª–∫—É">

        <div id="wifi_fields">
            <input type="text" id="wifi_ssid" placeholder="–ò–º—è —Å–µ—Ç–∏ (SSID)">
            <input type="text" id="wifi_pass" placeholder="–ü–∞—Ä–æ–ª—å">
        </div>

        <div class="color-row">
            <span>–¶–≤–µ—Ç QR-–∫–æ–¥–∞:</span>
            <input type="color" id="qr_color" value="#000000">
        </div>

        <button class="main-btn" onclick="generateQR()">–°–æ–∑–¥–∞—Ç—å QR</button>

        <div id="qrcode-container">
            <div id="qrcode"></div>
            <button class="save-btn" onclick="downloadQR()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
            <p class="hint-text">–ù–∞–∂–º–∏—Ç–µ –∏ —É–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è</p>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let currentMode = 'text';
        let qrCodeInstance = null;

        function switchTab(mode) {
            currentMode = mode;
            document.getElementById('tab-text').classList.toggle('active', mode === 'text');
            document.getElementById('tab-wifi').classList.toggle('active', mode === 'wifi');
            
            document.getElementById('qr_input').style.display = (mode === 'text') ? 'block' : 'none';
            document.getElementById('wifi_fields').style.display = (mode === 'wifi') ? 'flex' : 'none';
        }

        function generateQR() {
            const color = document.getElementById("qr_color").value;
            const container = document.getElementById("qrcode-container");
            const qrDiv = document.getElementById("qrcode");
            let finalData = "";

            if (currentMode === 'text') {
                finalData = document.getElementById("qr_input").value;
            } else {
                const ssid = document.getElementById("wifi_ssid").value;
                const pass = document.getElementById("wifi_pass").value;
                if (!ssid.trim()) return tg.showAlert("–í–≤–µ–¥–∏—Ç–µ SSID (–∏–º—è —Å–µ—Ç–∏)!");
                finalData = `WIFI:S:${ssid};T:WPA;P:${pass};;`;
            }

            if (!finalData.trim()) return tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ!");

            qrDiv.innerHTML = "";
            container.style.display = "block";

            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞
            qrCodeInstance = new QRCode(qrDiv, {
                text: finalData,
                width: 512,
                height: 512,
                colorDark: color,
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });

            if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        }

        function downloadQR() {
            const canvas = document.querySelector("#qrcode canvas");
            
            if (!canvas) {
                tg.showAlert("–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ QR-–∫–æ–¥!");
                return;
            }

            try {
                // –ú–µ—Ç–æ–¥ 1: –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è canvas –≤ blob –∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
                canvas.toBlob(function(blob) {
                    if (!blob) {
                        // Fallback –º–µ—Ç–æ–¥
                        fallbackDownload(canvas);
                        return;
                    }

                    // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                    if (navigator.share) {
                        // Web Share API (—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö)
                        const file = new File([blob], "qrcode.png", { type: "image/png" });
                        navigator.share({
                            files: [file],
                            title: 'QR Code',
                            text: '–ú–æ–π QR-–∫–æ–¥'
                        }).catch(() => {
                            // –ï—Å–ª–∏ share –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –ø—Ä–æ–±—É–µ–º –æ–±—ã—á–Ω–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
                            downloadBlob(blob);
                        });
                    } else {
                        // –û–±—ã—á–Ω–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞
                        downloadBlob(blob);
                    }
                }, "image/png");

            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", error);
                fallbackDownload(canvas);
            }
        }

        function downloadBlob(blob) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = "qrcode.png";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        }

        function fallbackDownload(canvas) {
            // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ - –æ—Ç–∫—Ä—ã—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
            const dataUrl = canvas.toDataURL("image/png");
            const link = document.createElement("a");
            link.href = dataUrl;
            link.download = "qrcode.png";
            
            // –î–ª—è iOS
            if (navigator.userAgent.match(/iPhone|iPad|iPod/i)) {
                const newWindow = window.open();
                newWindow.document.write('<img src="' + dataUrl + '" style="max-width:100%"/>');
                newWindow.document.write('<p>–ù–∞–∂–º–∏—Ç–µ –∏ —É–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∑–∞—Ç–µ–º –≤—ã–±–µ—Ä–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"</p>');
            } else {
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        }
    </script>
</body>
</html>
